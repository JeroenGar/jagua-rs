name: Benchmark

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]

jobs:
  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Run benchmarks
        run: cargo bench --bench ci_bench -- --output-format bencher | tee output.txt

      - name: Create benchmark data directory
        run: mkdir -p benchmark-data

      - name: Store benchmark result
        uses: benchmark-action/github-action-benchmark@v1
        with:
          name: Rust Benchmarks
          tool: 'cargo'
          output-file-path: output.txt
          github-token: ${{ secrets.GITHUB_TOKEN }}
          # Do not auto-push to gh-pages in this repo
          auto-push: false
          # Generate local files for later deployment
          save-data-file: true
          external-data-json-path: ./benchmark-data/data.json
          # Performance alert settings
          comment-always: true
          alert-threshold: '110%'
          fail-on-alert: false
          alert-comment-cc-users: '@JeroenGar'

      - name: Deploy benchmark results
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          token: ${{ secrets.DOCS_PAT }}
          branch: gh-pages
          folder: benchmark-data
          repository-name: JeroenGar/jagua-rs-docs
          target-folder: benchmark
          clean: false
          commit-message: "auto deploy benchmark data"